<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neosmentis - Document</title>

    <link rel="stylesheet" href="css/root.css">
    <link rel="stylesheet" href="css/home.css">
    <link rel="stylesheet" href="css/doc.css">

    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">


    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Staatliches&display=swap"
        rel="stylesheet">

    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script script src="https://cdn.jsdelivr.net/npm/quill-image-resize-module"></script>
</head>

<body>
    <section class="left_section">
        <div class="neosmentis_logo_titre">
            <div class="div_logo">
                <img src="" alt="logo">
            </div>
            <div class="div_titre">
                <h1>Neosmentis</h1>
            </div>
        </div>
        <div class="div_menu_dashboard">
            <div class="big_menu_parent">
            </div>

        </div>
    </section>
    <section class="center_section">
        <div class="div_bnt_editor">
            <div class="div_research">
                <div class="div_titre_doc">
                    <input type="text" placeholder="Titre du document..." id="titre">
                </div>
                <div class="div_param">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20">
                        <path
                            d="m7.556 16.2-.412-2.137a7.367 7.367 0 0 1-.844-.394 5.062 5.062 0 0 1-.75-.525l-2.063.694-1.443-2.494 1.631-1.425a5.53 5.53 0 0 1-.056-1.388c.012-.15.031-.3.056-.45L2.044 6.656l1.443-2.494 2.063.694c.237-.2.487-.375.75-.525.275-.15.556-.281.844-.394L7.556 1.8h2.888l.412 2.138c.288.112.563.243.825.393.275.15.532.325.769.525l2.063-.694 1.443 2.494-1.631 1.425a5.53 5.53 0 0 1 .056 1.388c-.012.15-.031.3-.056.45l1.631 1.425-1.444 2.494-2.062-.694c-.237.2-.494.375-.769.525-.262.15-.537.281-.825.393l-.412 2.138H7.556Zm1.106-1.35h.675l.357-1.856c.475-.088.918-.25 1.331-.488a3.903 3.903 0 0 0 1.069-.9l1.8.6.337-.562-1.425-1.257c.075-.212.132-.43.169-.656a3.54 3.54 0 0 0 0-1.444 3.809 3.809 0 0 0-.169-.675l1.425-1.256-.337-.562-1.8.6a3.903 3.903 0 0 0-1.069-.9 4.157 4.157 0 0 0-1.331-.488L9.337 3.15h-.675l-.356 1.856c-.475.088-.918.25-1.331.488a3.903 3.903 0 0 0-1.069.9l-1.8-.6-.337.562 1.425 1.256a5.319 5.319 0 0 0-.188.675 4.682 4.682 0 0 0 0 1.444c.05.225.113.444.188.656l-1.425 1.257.337.562 1.8-.6c.3.363.657.663 1.069.9.413.238.856.4 1.331.488l.357 1.856ZM9 11.7c.75 0 1.387-.262 1.912-.787A2.604 2.604 0 0 0 11.7 9c0-.75-.262-1.388-.787-1.912A2.604 2.604 0 0 0 9 6.3c-.75 0-1.388.263-1.912.788A2.604 2.604 0 0 0 6.3 9c0 .75.263 1.387.788 1.912A2.604 2.604 0 0 0 9 11.7Z" />
                    </svg>
                </div>
                <div class="div_share">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
                        <path
                            d="M11.1002 3C7.45057 3.00657 5.53942 3.09617 4.31806 4.31754C3 5.63559 3 7.75698 3 11.9997C3 16.2425 3 18.3639 4.31806 19.6819C5.63611 21 7.7575 21 12.0003 21C16.243 21 18.3644 21 19.6825 19.6819C20.9038 18.4606 20.9934 16.5494 21 12.8998"
                            stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                        <path
                            d="M20.9995 6.02511L20 6.02258C16.2634 6.01313 14.3951 6.0084 13.0817 6.95247C12.6452 7.2662 12.2622 7.64826 11.9474 8.08394C11 9.39497 11 11.2633 11 14.9998M20.9995 6.02511C21.0062 5.86248 20.9481 5.69887 20.8251 5.55315C20.0599 4.64668 18.0711 2.99982 18.0711 2.99982M20.9995 6.02511C20.9934 6.17094 20.9352 6.31598 20.8249 6.44663C20.0596 7.35292 18.0711 8.99982 18.0711 8.99982"
                            stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>

                    <div class="div_notif_event">

                    </div>
                </div>
            </div>
        </div>
        <div id="editor-container"></div>
    </section>

</body>
<script src="js/document/document.js"></script>
<script src="js/home/center_menu_profil_menu.js"></script>
<script>
    // get url param doc
    const urlParams = new URLSearchParams(window.location.search);
    let doc = urlParams.get('doc');
    doc = atob(doc);
    console.log("doc",doc);

    window.addEventListener('load', function () {
        getDoc();
    });
    async function get_user_pictures() {

        let response = await fetch('/get_user_pictures');
        let data = await response.json();
        return data;
    }

    var quill = new Quill('#editor-container', {
        theme: 'snow',
        modules: {
            toolbar: {
                container: [
                    [{ header: [1, 2, 3, false] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'color': [] }, { 'background': [] }],
                    [{ 'script': 'sub' }, { 'script': 'super' },{ 'direction': 'rtl' }],
                    [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                    [{ 'indent': '-1' },{ 'align': [] }, { 'indent': '+1' }],
                    [{ 'size': ['small', false, 'large', 'huge'] }],
                    [{ 'font': [] }],
                    ['blockquote', 'code-block'],
                    ['link', 'image', 'video'],
                    ['clean']
                ],
                handlers: {
                    image: async function () {
                        var range = this.quill.getSelection();
                        let loaderIndex = range.index;


                        var input = document.createElement('input');
                        input.classList.add("input_img");
                        input.type = 'file';
                        input.accept = 'image/*';

                        var ok = document.createElement('button');
                        ok.textContent = 'OK';


                        // Create a div to add additional elements
                        var div = document.createElement('div');
                        div.classList.add('image-upload');

                        document.addEventListener('click', (e) => {
                            if (e.target != input && e.target != ok && e.target.closest('.div_images') == null) {
                                div.remove();
                            }
                        });

                        // Add any additional elements you want to the div
                        var additionalElement = document.createElement('p');
                        additionalElement.textContent = 'Please select an image or uplad a new one';

                        div.appendChild(additionalElement);

                        let div_images = document.createElement('div');
                        div_images.classList.add('div_images');

                        await get_user_pictures().then(data => {
                            let images = data.images;
                            images.forEach(image => {
                                let imgContainer = document.createElement('div');
                                imgContainer.classList.add('img_container');

                                // Add a loading spinner
                                let spinner = document.createElement('div');
                                spinner.classList.add('spinner');
                                imgContainer.appendChild(spinner);

                                // Create an image element
                                let img = new Image();
                                img.src = image.url;
                                imgContainer.style.backgroundImage = `url(${image.url})`;
                                img.onload = () => {
                                    // Remove spinner once image is loaded
                                    spinner.remove();
                                };
                                // imgContainer.appendChild(img);


                                imgContainer.onclick = (e) => {

                                    if (e.target.classList.contains("delete_img")) {
                                        console.log('delete');
                                        fetch('/delete_image', {
                                            method: 'POST',
                                            headers: {
                                                'Content-Type': 'application/json'
                                            },
                                            body: JSON.stringify({ url: image.url })
                                        })
                                            .then(resp => resp.json())
                                            .then(data => {
                                                console.log(data);
                                                if (data.success == true) {
                                                    imgContainer.remove();
                                                }
                                            });
                                    } else {
                                        this.quill.insertEmbed(range.index, 'image', image.url);
                                        div.remove();
                                        var content = quill.root.innerHTML;
                                        save_doc(content);
                                    }


                                }


                                let delet_div = document.createElement('div');
                                delet_div.classList.add('delete_img');
                                delet_div.innerHTML = 'X';

                                imgContainer.onmouseover = () => {
                                    delet_div.style.display = 'flex';
                                }

                                imgContainer.onmouseleave = () => {
                                    delet_div.style.display = 'none';
                                }
                                imgContainer.appendChild(delet_div);


                                div_images.appendChild(imgContainer);
                            });
                        });
                        div.appendChild(div_images);
                        div.appendChild(input);


                        // Append the div to the body or any other container
                        document.body.appendChild(div);

                        input.onchange = () => {
                            var file = input.files[0];
                            if (file) {
                                div.remove();
                                this.quill.insertText(range.index, 'Loading...', 'silent');
                                let loaderIndex = range.index;
                                let elem_from_index = this.quill.getLeaf(range.index);
                                console.log(elem_from_index[0].parent.domNode);
                                elem_from_index[0].parent.domNode.classList.add('loader_img');

                                var formData = new FormData();

                                reel_size = file.size;
                                img_size = reel_size / 1024 / 1024; // recupère la taille de l'image en Mo

                                // recupère la vitesse du reseau
                                var speed = 1; // default speed
                                if (navigator.connection) {
                                    speed = navigator.connection.downlink;
                                } else if (navigator.mozConnection) {
                                    speed = navigator.mozConnection.downlink;
                                }
                                console.log('speed: ' + img_size / speed);
                                if ((img_size / speed) > 3) {
                                    list_notif_texte.push(['Uploading image, it may take a while']);
                                }

                                formData.append('image', file);
                                fetch('/upload_image', {
                                    method: 'POST',
                                    body: formData
                                })
                                    .then(resp => resp.json())
                                    .then(data => {
                                        this.quill.deleteText(loaderIndex, 'Loading...'.length);
                                        this.quill.insertEmbed(range.index, 'image', data.file.url);
                                        var content = quill.root.innerHTML;
                                        save_doc(content);
                                    });
                            }
                        };
                    }
                }
            },
            imageResize: {
                displayStyles: {
                    backgroundColor: 'black',
                    border: 'none',
                    color: 'white'
                },
                modules: ['Resize', 'DisplaySize', 'Toolbar']
            }
        }
    });

    // quill is ready
    console.log('quill is ready');

    // document.getElementById('saveButton').addEventListener('click', function () {
    //     var content = quill.root.innerHTML;
    //     save_doc(content);
    // });


    

</script>

</html>